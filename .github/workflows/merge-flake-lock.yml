name: Merge flake.lock PR

on:
  workflow_run:
    workflows: ["flake-ci"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    # Only run when CI succeeded on a pull request
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Locate flake.lock PR
        id: pr
        run: |
          PR=$(jq -r '.workflow_run.pull_requests[0].number // empty' "$GITHUB_EVENT_PATH")
          if [ -n "$PR" ]; then
            echo "pr=$PR" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          PR=$(gh pr list \
            --label flake-lock \
            --state open \
            --json number \
            --jq '.[0].number')
          echo "pr=$PR" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Merge flake.lock PR
        if: steps.pr.outputs.pr != ''
        run: gh pr merge --auto --squash ${{ steps.pr.outputs.pr }}
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
