#!/usr/bin/env zsh
set -euo pipefail

quiet=0
[[ "${1:-}" == "--quiet" ]] && quiet=1

secrets_file="$HOME/.secrets"
ap="associatedpressteam"
my="my"

has_op() { command -v op >/dev/null 2>&1 }
has_op_accounts() { has_op && op account list >/dev/null 2>&1 }
is_op_unlocked() { has_op_accounts && op account get >/dev/null 2>&1 }

op_required() {
  local label="$1"
  local ref="$2"
  local account="$3"

  local value
  value="$(op read "$ref" --account "$account" 2>/dev/null || true)"

  if [[ -z "$value" ]]; then
    echo "update-secrets: missing secret: $label" >&2
    echo "  ref: $ref" >&2
    echo "  account: $account" >&2
    exit 1
  fi

  print -r -- "$value"
}

if ! is_op_unlocked; then
  if has_op_accounts; then
    (( quiet )) || echo "1Password locked; signing inâ€¦"

    if ! command -v jq >/dev/null 2>&1; then
      echo "update-secrets: jq is required" >&2
      exit 1
    fi

    for acct in ${(f)"$(op account list --format=json | jq -r '.[].shorthand')"}; do
      eval "$(op signin --account \"$acct\")"
    done
  else
    (( quiet )) || echo "1Password not configured; skipping secrets update."
    exit 0
  fi
fi

tmp="$secrets_file.tmp"
{
  echo "export AZURE_DEFAULT_USERNAME=\"$(op_required AZURE_DEFAULT_USERNAME 'op://private/office 365/username' "$ap")\""
  echo "export AZURE_DEFAULT_PASSWORD=\"$(op_required AZURE_DEFAULT_PASSWORD 'op://private/office 365/username' "$ap")\""
  echo "export GITLAB_TOKEN=\"$(op_required GITLAB_TOKEN 'op://private/gitlab personal access token/token' "$ap")\""
  echo "export TF_HTTP_PASSWORD=\"$(op_required TF_HTTP_PASSWORD 'op://private/gitlab personal access token/token' "$ap")\""
  echo "export TF_HTTP_USERNAME=\"$(op_required TF_HTTP_USERNAME 'op://private/gitlab personal access token/username' "$ap")\""
  echo "export TF_VAR_gitlab_token=\"$(op_required TF_VAR_gitlab_token 'op://gss/GitLab_tfadmin-cdenneen/credential' "$ap")\""
  echo "export CI_REGISTRY_USER=\"$(op_required CI_REGISTRY_USER 'op://Amazon Web Services/JFrog_gitlabci/username' "$ap")\""
  echo "export CI_REGISTRY_PASSWORD=\"$(op_required CI_REGISTRY_PASSWORD 'op://Amazon Web Services/JFrog_gitlabci/credential' "$ap")\""
  echo "export GI_RENOVATE_TOKEN=\"$(op_required GI_RENOVATE_TOKEN 'op://gss/GitLab_gi-renovate/credential' "$ap")\""
  echo "export RENOVATE_TOKEN=\"$(op_required RENOVATE_TOKEN 'op://gss/GitLab_renovate-runner-ci/credential' "$ap")\""
  echo "export DOCKER_HUB_PASSWORD=\"$(op_required DOCKER_HUB_PASSWORD 'op://gss/DockerHub_token/credential' "$ap")\""
  echo "export GITHUB_TOKEN=\"$(op_required GITHUB_TOKEN 'op://private/GH_TOKEN/token' "$my")\""
  # Allow Nix to authenticate against GitHub when a token is available.
  echo 'export NIX_CONFIG="${NIX_CONFIG:+$NIX_CONFIG }access-tokens = github.com=${GITHUB_TOKEN}"'
  echo "export OPENAI_API_KEY=\"$(op_required OPENAI_API_KEY 'op://private/OpenAI/credential' "$ap")\""
} > "$tmp"

if ! cmp -s "$tmp" "$secrets_file" 2>/dev/null; then
  mv "$tmp" "$secrets_file"
  (( quiet )) || echo "Secrets updated in $secrets_file"
else
  rm -f "$tmp"
fi
